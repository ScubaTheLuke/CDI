<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CDI Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <h1>CDI Tracker</h1>
            <p class="tagline">Classy inventory, sales, and ledger management for MTG dealers.</p>
        </div>
        <div class="header-right">
            <label class="theme-toggle">
                <input type="checkbox" id="theme-toggle-input">
                <span class="slider"></span>
                <span class="label">Classic Mode</span>
            </label>
        </div>
    </header>

    <nav class="tab-nav">
        <button class="tab-button active" data-target="dashboard">Dashboard</button>
        <button class="tab-button" data-target="inventory">Inventory</button>
        <button class="tab-button" data-target="add-items">Add Items</button>
        <button class="tab-button" data-target="sales">Sales &amp; History</button>
        <button class="tab-button" data-target="ledger">Business Ledger</button>
    </nav>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main>
        <section id="dashboard" class="tab-section active">
            <div class="cards-grid">
                <article class="info-card">
                    <h3>Single Cards</h3>
                    <p>Total Quantity <span class="tooltip-icon" tabindex="0" data-tooltip="Sum of all copies of single cards currently in inventory.">?</span>: <strong>{{ summary.single_card_quantity }}</strong></p>
                    <p>Buy Cost <span class="tooltip-icon" tabindex="0" data-tooltip="Total cost basis for single cards on hand (acquisition price per card x quantity).">?</span>: <strong>{{ summary.single_card_buy_cost|currency }}</strong></p>
                    <p>Market Value <span class="tooltip-icon" tabindex="0" data-tooltip="Estimated market value for single cards (latest market price per card x quantity).">?</span>: <strong>{{ summary.single_card_market_value|currency }}</strong></p>
                </article>
                <article class="info-card">
                    <h3>Sealed Products</h3>
                    <p>Total Quantity <span class="tooltip-icon" tabindex="0" data-tooltip="Sum of all sealed products currently in inventory.">?</span>: <strong>{{ summary.sealed_quantity }}</strong></p>
                    <p>Buy Cost <span class="tooltip-icon" tabindex="0" data-tooltip="Total acquisition cost for sealed products on hand (purchase price per unit x quantity).">?</span>: <strong>{{ summary.sealed_buy_cost|currency }}</strong></p>
                    <p>Market Value <span class="tooltip-icon" tabindex="0" data-tooltip="Estimated market value for sealed products (current market price per unit x quantity).">?</span>: <strong>{{ summary.sealed_market_value|currency }}</strong></p>
                </article>
                <article class="info-card">
                    <h3>Sales Performance (All Time)</h3>
                    <p>Gross Sales <span class="tooltip-icon" tabindex="0" data-tooltip="Total sale price of items sold (excludes customer shipping charges).">?</span>: <strong>{{ summary.gross_sales|currency }}</strong></p>
                    <p>COGS <span class="tooltip-icon" tabindex="0" data-tooltip="Total cost of goods sold for recorded sales (inventory acquisition cost of items sold).">?</span>: <strong>{{ summary.total_cogs|currency }}</strong></p>
                    <p>Realized Profit/Loss <span class="tooltip-icon" tabindex="0" data-tooltip="Net profit from sales after COGS, actual postage, platform fees, and shipping supplies, including shipping income.">?</span>: <strong>{{ summary.total_profit|currency }}</strong></p>
                </article>
                <article class="info-card">
                    <h3>Net Business P/L</h3>
                    <p>Net Business P/L (All Time) <span class="tooltip-icon" tabindex="0" data-tooltip="Sales profit plus ledger income and expenses, adding back shipping supply costs so they are not counted twice.">?</span>: <strong>{{ summary.net_business_pl|currency }}</strong></p>
                    <p>Current Month Sales <span class="tooltip-icon" tabindex="0" data-tooltip="Gross sales for this month based on sale prices only (no customer shipping charges).">?</span>: <strong>{{ summary.current_month_sales|currency }}</strong></p>
                    <p>Current Month P/L <span class="tooltip-icon" tabindex="0" data-tooltip="Realized profit or loss from this month's sales after COGS, postage, platform fees, and supplies.">?</span>: <strong>{{ summary.current_month_profit|currency }}</strong></p>
                </article>
                <article class="info-card">
                    <h3>Shipping Supplies</h3>
                    <p>Total Cost Used in Sales <span class="tooltip-icon" tabindex="0" data-tooltip="Total shipping supply costs allocated to completed sales.">?</span>: <strong>{{ summary.total_supplies_cost|currency }}</strong></p>
                </article>
            </div>
        </section>

        <section id="inventory" class="tab-section">
            <div class="inventory-switcher" role="tablist" aria-label="Inventory views">
                <button type="button" class="inventory-tab active" data-inventory-target="singles">Single Cards</button>
                <button type="button" class="inventory-tab" data-inventory-target="sealed">Sealed Products</button>
                <button type="button" class="inventory-tab" data-inventory-target="supplies">Shipping Supplies</button>
            </div>

            <div class="inventory-section active" data-inventory-section="singles">
                <div class="panel">
                    <header class="panel-header">
                        <div>
                            <h2>Single Card Inventory</h2>
                            <p>Filter by name, set, or notes.</p>
                        </div>
                        <div class="actions">
                            <input type="text" id="card-filter" placeholder="Filter cards">
                            <button id="card-mass-edit" class="secondary">Advanced Update</button>
                        </div>
                    </header>
                    <div class="panel-body">
                        <div class="table-wrapper">
                            <table id="cards-table" class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Card</th>
                                        <th>Set</th>
                                        <th>#</th>
                                        <th>Qty</th>
                                        <th>Buy</th>
                                        <th>Live Market</th>
                                        <th>Condition</th>
                                        <th>Language</th>
                                        <th>Foil</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for card in cards %}
                                    <tr
                                        data-name="{{ card.name|lower }}"
                                        data-set="{{ card.set_code|default('')|lower }}"
                                        data-notes="{{ card.notes|default('')|lower }}"
                                        data-condition="{{ card.condition|default('')|lower }}"
                                        data-language="{{ card.language|default('')|lower }}"
                                        data-foil="{{ 'foil' if card.is_foil else 'nonfoil' }}"
                                    >
                                        <td class="card-name-cell" data-label="Card">
                                            <div class="card-name-wrap">
                                                {% if card.scryfall_image %}
                                                <img src="{{ card.scryfall_image }}" alt="{{ card.name }}" class="card-thumb">
                                                {% endif %}
                                                <div class="card-name-details">
                                                    <div class="card-name-title">
                                                        {% if card.scryfall_url %}
                                                        <a href="{{ card.scryfall_url }}" target="_blank" rel="noopener">{{ card.name }}</a>
                                                        {% else %}
                                                        {{ card.name }}
                                                        {% endif %}
                                                    </div>
                                                    <div class="card-name-meta">
                                                        {% if card.scryfall_set_name %}
                                                        <span class="card-set-name">{{ card.scryfall_set_name }}{% if card.scryfall_details and card.scryfall_details.rarity %} - {{ card.scryfall_details.rarity|title }}{% endif %}</span>
                                                        {% elif card.set_code %}
                                                        <span class="card-set-name">Set: {{ card.set_code }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td data-label="Set">{{ card.set_code }}</td>
                                        <td data-label="#">{{ card.collector_number }}</td>
                                        <td data-label="Qty">{{ card.quantity }}</td>
                                        <td data-label="Buy">{{ card.acquisition_price|currency }}</td>
                                        <td data-label="Live Market" class="market-cell">
                                            {% if card.scryfall_price %}
                                            <div class="market-price-live">{{ card.scryfall_price|currency }}</div>
                                            {% else %}
                                            <div class="market-price-live muted">N/A</div>
                                            {% endif %}
                                            {% if card.scryfall_price_normal and card.scryfall_price != card.scryfall_price_normal %}
                                            <div class="market-price-variant">Non-foil: {{ card.scryfall_price_normal|currency }}</div>
                                            {% endif %}
                                            {% if card.scryfall_price_foil and card.scryfall_price != card.scryfall_price_foil %}
                                            <div class="market-price-variant">Foil: {{ card.scryfall_price_foil|currency }}</div>
                                            {% endif %}
                                            {% if card.market_price %}
                                            <div class="market-price-stored">Stored: {{ card.market_price|currency }}</div>
                                            {% endif %}
                                        </td>
                                        <td data-label="Condition">{{ card.condition }}</td>
                                        <td data-label="Language">{{ card.language }}</td>
                                        <td data-label="Foil">{{ 'Foil' if card.is_foil else 'Non-Foil' }}</td>
                                        <td data-label="Notes">{{ card.notes }}</td>
                                        <td data-label="Actions">
                                            <form method="post" action="{{ url_for('delete_card', card_id=card.id) }}" onsubmit="return confirm('Delete this card?');">
                                                <button type="submit" class="danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="card-pagination" class="pagination" aria-label="Card pages"></nav>
                    </div>
                </div>
            </div>

            <div class="inventory-section" data-inventory-section="sealed">
                <div class="panel">
                    <header class="panel-header">
                        <div>
                            <h2>Sealed Product Inventory</h2>
                            <p>Track sealed boxes, packs, and accessories.</p>
                        </div>
                    </header>
                    <div class="panel-body">
                        <div class="table-wrapper">
                            <table id="sealed-table" class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Set</th>
                                        <th>Type</th>
                                        <th>Qty</th>
                                        <th>Buy</th>
                                        <th>Market</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in sealed_products %}
                                    <tr
                                        data-name="{{ product.name|lower }}"
                                        data-set="{{ product.set_code|default('')|lower }}"
                                        data-notes="{{ product.notes|default('')|lower }}"
                                        data-type="{{ product.product_type|default('')|lower }}"
                                    >
                                        <td data-label="Name">{{ product.name }}</td>
                                        <td data-label="Set">{{ product.set_code }}</td>
                                        <td data-label="Type">{{ product.product_type }}</td>
                                        <td data-label="Qty">{{ product.quantity }}</td>
                                        <td data-label="Buy">{{ product.acquisition_price|currency }}</td>
                                        <td data-label="Market">{{ product.market_price|currency }}</td>
                                        <td data-label="Notes">{{ product.notes }}</td>
                                        <td data-label="Actions">
                                            <form method="post" action="{{ url_for('delete_sealed_product', product_id=product.id) }}" onsubmit="return confirm('Delete this sealed product?');">
                                                <button type="submit" class="danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="sealed-pagination" class="pagination" aria-label="Sealed product pages"></nav>
                    </div>
                </div>
            </div>

            <div class="inventory-section" data-inventory-section="supplies">
                <div class="panel">
                    <header class="panel-header">
                        <div>
                            <h2>Shipping Supply Batches</h2>
                            <p>Monitor postage materials consumed in sales.</p>
                        </div>
                    </header>
                    <div class="panel-body">
                        <div class="table-wrapper">
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Supplier</th>
                                        <th>Unit Cost</th>
                                        <th>Purchased</th>
                                        <th>Available</th>
                                        <th>Date</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for batch in supply_batches %}
                                    <tr>
                                        <td data-label="Description">{{ batch.description }}</td>
                                        <td data-label="Supplier">{{ batch.supplier }}</td>
                                        <td data-label="Unit Cost">{{ batch.unit_cost|currency }}</td>
                                        <td data-label="Purchased">{{ batch.quantity_purchased }}</td>
                                        <td data-label="Available">{{ batch.quantity_available }}</td>
                                        <td data-label="Date">{{ batch.purchased_at|dateformat }}</td>
                                        <td data-label="Notes">{{ batch.notes }}</td>
                                        <td data-label="Actions">
                                            <form method="post" action="{{ url_for('delete_supply_batch', batch_id=batch.id) }}" onsubmit="return confirm('Delete this supply batch?');">
                                                <button type="submit" class="danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="add-items" class="tab-section">
            <div class="forms-grid">
                <form class="form-card" method="post" action="{{ url_for('add_single_card') }}">
                    <div class="form-card-header">
                        <h2>Add Single Card</h2>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <label for="card-name">Card Name</label>
                            <input type="text" id="card-name" name="name" required>
                        </div>
                        <div class="form-row">
                            <label for="card-set">Set Code</label>
                            <input type="text" id="card-set" name="set_code" placeholder="mh3">
                        </div>
                        <div class="form-row">
                            <label for="collector-number">Collector Number</label>
                            <input type="text" id="collector-number" name="collector_number">
                        </div>
                        <div class="form-row">
                            <label for="card-condition">Condition</label>
                            <input type="text" id="card-condition" name="condition" placeholder="NM">
                        </div>
                        <div class="form-row">
                            <label for="card-language">Language</label>
                            <input type="text" id="card-language" name="language" placeholder="EN">
                        </div>
                        <div class="form-row checkbox-row">
                            <label for="card-foil">Foil</label>
                            <input type="checkbox" id="card-foil" name="is_foil">
                        </div>
                        <div class="form-row">
                            <label for="card-quantity">Quantity</label>
                            <input type="number" id="card-quantity" name="quantity" min="0" value="0">
                        </div>
                        <div class="form-row">
                            <label for="card-buy">Buy Price (each)</label>
                            <input type="number" step="0.01" id="card-buy" name="acquisition_price" value="0">
                        </div>
                        <div class="form-row">
                            <label for="card-market">Market Price (each)</label>
                            <input type="number" step="0.01" id="card-market" name="market_price" value="0">
                        </div>
                        <div class="form-row">
                            <label for="card-date">Acquired Date</label>
                            <input type="date" id="card-date" name="acquired_at">
                        </div>
                        <div class="form-row full-span">
                            <label for="card-notes">Notes</label>
                            <textarea id="card-notes" name="notes" rows="3"></textarea>
                        </div>
                        <input type="hidden" id="card-scryfall-id" name="scryfall_id">
                    </div>
                    <div class="form-card-footer form-actions">
                        <button type="button" id="scryfall-search" class="secondary">Lookup on Scryfall</button>
                        <button type="submit">Add Card</button>
                    </div>
                </form>

                <form class="form-card" method="post" action="{{ url_for('import_card_inventory') }}" enctype="multipart/form-data">
                    <div class="form-card-header">
                        <h2>Import Card Inventory</h2>
                        <p class="form-help">Upload a CSV from TCGplayer or TCG Live.</p>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row file-row">
                            <label class="file-drop">
                                <span class="file-drop-text">Drag & drop your CSV here, or click to browse.</span>
                                <input type="file" id="inventory-csv" name="inventory_csv" accept=".csv" required>
                            </label>
                        </div>
                    </div>
                    <div class="form-card-footer form-actions">
                        <button type="submit">Import Cards</button>
                    </div>
                </form>

                <form class="form-card" method="post" action="{{ url_for('add_sealed_product') }}">
                    <div class="form-card-header">
                        <h2>Add Sealed Product</h2>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <label for="sealed-name">Product Name</label>
                            <input type="text" id="sealed-name" name="name" required>
                        </div>
                        <div class="form-row">
                            <label for="sealed-set">Set Code</label>
                            <input type="text" id="sealed-set" name="set_code">
                        </div>
                        <div class="form-row">
                            <label for="sealed-type">Product Type</label>
                            <input type="text" id="sealed-type" name="product_type" placeholder="Booster Box">
                        </div>
                        <div class="form-row">
                            <label for="sealed-quantity">Quantity</label>
                            <input type="number" id="sealed-quantity" name="quantity" min="0" value="0">
                        </div>
                        <div class="form-row">
                            <label for="sealed-buy">Buy Price (each)</label>
                            <input type="number" step="0.01" id="sealed-buy" name="acquisition_price" value="0">
                        </div>
                        <div class="form-row">
                            <label for="sealed-market">Market Price (each)</label>
                            <input type="number" step="0.01" id="sealed-market" name="market_price" value="0">
                        </div>
                        <div class="form-row">
                            <label for="sealed-date">Acquired Date</label>
                            <input type="date" id="sealed-date" name="acquired_at">
                        </div>
                        <div class="form-row full-span">
                            <label for="sealed-notes">Notes</label>
                            <textarea id="sealed-notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-card-footer form-actions">
                        <button type="submit">Add Sealed Product</button>
                    </div>
                </form>

                <form class="form-card" method="post" action="{{ url_for('add_supply_batch') }}">
                    <div class="form-card-header">
                        <h2>Add Shipping Supplies</h2>
                    </div>
                    <div class="form-card-body">
                        <div class="form-row">
                            <label for="supply-description">Description</label>
                            <input type="text" id="supply-description" name="description" required>
                        </div>
                        <div class="form-row">
                            <label for="supply-supplier">Supplier</label>
                            <input type="text" id="supply-supplier" name="supplier">
                        </div>
                        <div class="form-row">
                            <label for="supply-quantity">Quantity Purchased</label>
                            <input type="number" id="supply-quantity" name="quantity_purchased" min="0" value="0">
                        </div>
                        <div class="form-row">
                            <label for="supply-unit-cost">Unit Cost</label>
                            <input type="number" step="0.01" id="supply-unit-cost" name="unit_cost" value="0">
                        </div>
                        <div class="form-row">
                            <label for="supply-date">Purchase Date</label>
                            <input type="date" id="supply-date" name="purchased_at" value="{{ today|dateformat }}">
                        </div>
                        <div class="form-row full-span">
                            <label for="supply-notes">Notes</label>
                            <textarea id="supply-notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-card-footer form-actions">
                        <button type="submit">Add Supply Batch</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="sales" class="tab-section">
            <div class="panel">
                <header class="panel-header">
                    <div>
                        <h2>Record a New Multi-Item Sale</h2>
                        <p>Select inventory items and supplies used, then submit.</p>
                    </div>
                </header>
                <div class="panel-body">
                    <form id="sale-form">
                        <div class="form-grid">
                            <div>
                                <label for="sale-date">Sale Date</label>
                                <input type="date" id="sale-date" name="sale_date" value="{{ today|dateformat }}">
                            </div>
                            <div>
                                <label for="sale-platform">Platform</label>
                                <input type="text" id="sale-platform" name="platform" placeholder="TCGplayer">
                            </div>
                            <div>
                                <label for="sale-shipping-charged">Customer Shipping Charged</label>
                                <input type="number" step="0.01" id="sale-shipping-charged" name="customer_shipping_charged" value="0">
                            </div>
                            <div>
                                <label for="sale-postage">Actual Postage Cost</label>
                                <input type="number" step="0.01" id="sale-postage" name="actual_postage_cost" value="0">
                            </div>
                            <div>
                                <label for="sale-fees">Platform Fees</label>
                                <input type="number" step="0.01" id="sale-fees" name="platform_fees" value="0">
                            </div>
                            <div>
                                <label for="sale-notes">Notes</label>
                                <input type="text" id="sale-notes" name="notes">
                            </div>
                        </div>

                        <div class="sale-section">
                            <h3>Items Sold</h3>
                            <div class="sale-controls">
                                <select id="sale-item-select"></select>
                                <input type="number" id="sale-item-quantity" min="1" value="1">
                                <input type="number" step="0.01" id="sale-item-price" placeholder="Sale price each">
                                <button type="button" id="add-sale-item" class="secondary">Add Item</button>
                            </div>
                            <div class="table-wrapper">
                                <table id="sale-items-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Type</th>
                                            <th>Qty</th>
                                            <th>Sale Price</th>
                                            <th>Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="sale-section">
                            <h3>Shipping Supplies Used</h3>
                            <div class="sale-controls">
                                <select id="sale-supply-select"></select>
                                <input type="number" id="sale-supply-quantity" min="1" value="1">
                                <button type="button" id="add-sale-supply" class="secondary">Add Supply</button>
                            </div>
                            <div class="table-wrapper">
                                <table id="sale-supplies-table">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Qty Used</th>
                                            <th>Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit">Record Sale</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="panel">
                <header class="panel-header">
                    <h2>Sales History</h2>
                </header>
                <div class="panel-body">
                    <div class="sales-history">
                        {% for event in sale_events %}
                        <details class="sale-entry">
                            <summary>
                                <span>{{ event.sale_date|dateformat }}</span>
                                <span>{{ event.platform or 'Direct' }}</span>
                                <span>{{ event.total_profit_loss|currency }}</span>
                                <form method="post" action="{{ url_for('delete_sale', event_id=event.id) }}" onsubmit="return confirm('Delete this sale event?');">
                                    <button type="submit" class="danger">Delete</button>
                                </form>
                            </summary>
                            <div class="sale-entry-body">
                                <h4>Items</h4>
                                <ul>
                                    {% for item in event['items'] %}
                                    <li>
                                        {{ item.quantity }}x {{ item.item_name }} ({{ item.set_code }}) at {{ item.sale_price_per_unit|currency }} each &mdash; Profit {{ item.profit_loss|currency }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% if event['supplies'] %}
                                <h4>Supplies</h4>
                                <ul>
                                    {% for supply in event['supplies'] %}
                                    <li>{{ supply.quantity_used }}x batch #{{ supply.supply_batch_id }} at {{ supply.unit_cost|currency }} ({{ supply.total_cost|currency }})</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                                <div class="sale-metrics">
                                    <p>Gross: {{ event.total_sale_amount|currency }}</p>
                                    <p>COGS: {{ event.total_cost_of_goods|currency }}</p>
                                    <p>Supplies: {{ event.total_supplies_cost_for_sale|currency }}</p>
                                    <p>Shipping Charged: {{ event.customer_shipping_charged|currency }}</p>
                                    <p>Postage: {{ event.actual_postage_cost|currency }}</p>
                                    <p>Platform Fees: {{ event.platform_fees|currency }}</p>
                                    <p>Net Profit/Loss: <strong>{{ event.total_profit_loss|currency }}</strong></p>
                                    <p>Notes: {{ event.notes }}</p>
                                </div>
                            </div>
                        </details>
                        {% else %}
                        <p>No sales recorded yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        
<section id="ledger" class="tab-section">
            <div class="panel">
                <header class="panel-header">
                    <h2>Add Ledger Entry</h2>
                </header>
                <div class="panel-body">
                    <form method="post" action="{{ url_for('add_ledger_entry') }}" class="ledger-form">
                        <div class="form-row">
                            <label for="ledger-date">Date</label>
                            <input type="date" id="ledger-date" name="entry_date" value="{{ today|dateformat }}">
                        </div>
                        <div class="form-row">
                            <label for="ledger-description">Description</label>
                            <input type="text" id="ledger-description" name="description" required>
                        </div>
                        <div class="form-row">
                            <label for="ledger-amount">Amount</label>
                            <input type="number" step="0.01" id="ledger-amount" name="amount" required>
                        </div>
                        <div class="form-row">
                            <label for="ledger-category">Category</label>
                            <input type="text" id="ledger-category" name="category">
                        </div>
                        <div class="form-actions">
                            <button type="submit">Add Entry</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="panel">
                <header class="panel-header">
                    <h2>Ledger Entries</h2>
                </header>
                <div class="panel-body">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in ledger_entries %}
                                <tr>
                                    <td>{{ entry.entry_date|dateformat }}</td>
                                    <td>{{ entry.description }}</td>
                                    <td>{{ entry.category }}</td>
                                    <td>{{ entry.amount|currency }}</td>
                                    <td>
                                        <form method="post" action="{{ url_for('delete_ledger_entry', entry_id=entry.id) }}" onsubmit="return confirm('Delete this ledger entry?');">
                                            <button type="submit" class="danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal">
            <h3 id="modal-title">Mass Update</h3>
            <form id="modal-form">
                <fieldset class="modal-fieldset">
                    <legend>Filters</legend>
                    <p class="modal-help">Only cards matching all provided filters will be updated. Leave a field blank to ignore it.</p>
                    <div class="form-row">
                        <label for="filter-set-code">Set Code</label>
                        <input type="text" id="filter-set-code" name="filter_set_code" placeholder="e.g., MH3">
                    </div>
                    <div class="form-row">
                        <label for="filter-condition">Condition</label>
                        <input type="text" id="filter-condition" name="filter_condition" placeholder="e.g., NM">
                    </div>
                    <div class="form-row">
                        <label for="filter-language">Language</label>
                        <input type="text" id="filter-language" name="filter_language" placeholder="e.g., EN">
                    </div>
                    <div class="form-row">
                        <label for="filter-finish">Finish</label>
                        <select id="filter-finish" name="filter_finish">
                            <option value="">Foil or Non-Foil</option>
                            <option value="foil">Foil</option>
                            <option value="nonfoil">Non-Foil</option>
                        </select>
                    </div>
                </fieldset>
                <fieldset class="modal-fieldset">
                    <legend>Fields to Update</legend>
                    <p class="modal-help">Only supply values you want to override for the filtered cards.</p>
                    <div class="form-row">
                        <label for="modal-quantity">Quantity</label>
                        <input type="number" id="modal-quantity" name="quantity" placeholder="Leave blank to skip">
                    </div>
                    <div class="form-row">
                        <label for="modal-buy">Buy Price (each)</label>
                        <input type="number" step="0.01" id="modal-buy" name="acquisition_price" placeholder="Leave blank to skip">
                    </div>
                    <div class="form-row">
                        <label for="modal-market">Market Price (each)</label>
                        <input type="number" step="0.01" id="modal-market" name="market_price" placeholder="Leave blank to skip">
                    </div>
                </fieldset>
                <p class="modal-warning">Provide at least one filter and one field to update to run the bulk change.</p>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel" class="secondary">Cancel</button>
                    <button type="submit">Update</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const inventoryData = {
            cards: {{ cards|tojson }},
            sealed: {{ sealed_products|tojson }},
            supplies: {{ supply_batches|tojson }}
        };
    </script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>

